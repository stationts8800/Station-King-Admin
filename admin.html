<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Login</title>

<style>
body{
margin:0;
font-family:Arial, sans-serif;
background:#f5f5f5;
}

/* ===== LOGIN ===== */
#loginBox{
max-width:350px;
margin:150px auto;
background:#fff;
padding:20px;
border-radius:10px;
box-shadow:0 2px 8px rgba(0,0,0,0.2);
}

#loginBox h2{
text-align:center;
color:#ff6600;
}

input{
width:100%;
padding:10px;
margin:10px 0;
border-radius:6px;
border:1px solid #ccc;
}

button{
width:100%;
padding:10px;
background:#ff6600;
color:#fff;
border:none;
border-radius:6px;
font-size:16px;
}

/* ===== ADMIN ===== */
#adminPanel{
display:none;
}

header{
background:#ff6600;
color:#fff;
padding:15px;
text-align:center;
font-size:20px;
}

nav{
display:flex;
background:#fff;
border-bottom:1px solid #ddd;
}

nav button{
flex:1;
padding:12px;
border:none;
background:none;
font-size:12px;
width:auto;
}
.action-btn{
width:100%;
padding:10px;
background:#ff6600;
color:#fff;
border:none;
border-radius:6px;
font-size:16px;
cursor:pointer;
}

nav button.active{
color:#ff6600;
font-weight:bold;
border-bottom:2px solid #ff6600;
}

section{
display:none;
padding:15px;
}

section.active{
display:block;
}

.card{
background:#fff;
padding:12px;
border-radius:10px;
margin-bottom:12px;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.logout{
background:red;
margin:10px;
}
button:hover{
opacity:0.9;
}

button:active{
transform:scale(0.98);
}
</style>
</head>

<body>

<!-- ===== LOGIN ===== -->
<div id="loginBox">
<h2>เข้าสู่ระบบแอดมิน</h2>
<input type="email" id="user" placeholder="อีเมลแอดมิน">
<input type="password" id="pass" placeholder="รหัสผ่าน">
<button onclick="login()">เข้าสู่ระบบ</button>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="adminPanel">

<header>
ระบบหลังบ้าน
<button class="logout" onclick="logout()">ออกจากระบบ</button>
</header>

<nav>
<button class="active" onclick="openTab('product',this)">สินค้า</button>
<button onclick="openTab('order',this)">ออเดอร์</button>
<button onclick="openTab('payment',this)">บัญชี</button>
<button onclick="openTab('contact',this)">ติดต่อ</button>
</nav>

<section id="product" class="active">
  <hr>
<h3>เปลี่ยนโลโก้ร้าน</h3>
<input type="file" id="logoFile" accept="image/*">
<button class="action-btn" onclick="uploadLogo()">บันทึกโลโก้ใหม่</button>
<hr>
<div class="card">
<h3>เพิ่มสินค้า</h3>

<input id="pname" placeholder="ชื่อสินค้า">
<input id="pscent" placeholder="กลิ่น">
<input type="number" id="pprice" placeholder="ราคา">
<input type="number" id="pstock" placeholder="สินค้าคงเหลือ">
<input type="number" id="psold" placeholder="สินค้าขายแล้ว">
<input type="file" id="pimg">

<button class="action-btn" onclick="addProduct()">บันทึก</button>
<hr>
<h3>รายการสินค้า</h3>
<div id="productList"></div>

</div>
</section>

<section id="order">
<div class="card">
<h3>รายการออเดอร์</h3>
<div id="orderList"></div>
</div>
</section>

<section id="payment">
<div class="card">
<h3>บัญชีรับเงิน</h3>
<input placeholder="ชื่อบัญชี">
<input placeholder="ธนาคาร">
<input placeholder="เลขบัญชี">
<button class="action-btn">บันทึก</button>
</div>
</section>

<section id="contact">
<div class="card">
<h3>ข้อมูลติดต่อ</h3>
<input placeholder="เบอร์โทร">
<input placeholder="LINE">
<button class="action-btn">บันทึก</button>
</div>
</section>

</div>


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD_PEsWuy3Ad7Wfl6V1KmLYUxX_V5MDxto",
  authDomain: "openking-shop.firebaseapp.com",
  databaseURL: "https://openking-shop-default-rtdb.firebaseio.com",
  projectId: "openking-shop",
  storageBucket: "openking-shop.appspot.com",
  messagingSenderId: "408359377995",
  appId: "1:408359377995:web:32f3c2b29a06fa01abc1ce"
};

if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.database();
auth.onAuthStateChanged(function(user){
  if(user){
    db.ref("users/"+user.uid+"/role").once("value").then(snap=>{
      if(snap.val()==="admin"){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("adminPanel").style.display="block";
      }
    });
  }
});

</script>
<script>
// ===== LOGIN ADMIN ด้วย Firebase =====
function login(){
  let u=document.getElementById("user").value;
  let p=document.getElementById("pass").value;

  auth.signInWithEmailAndPassword(u,p)
  .then((cred)=>{

   db.ref("users/"+cred.user.uid+"/role")
    .once("value")
    .then(snapshot=>{

      if(snapshot.val()==="admin"){
        document.getElementById("loginBox").style.display="none";
       document.getElementById("adminPanel").style.display="block";
      }else{
        alert("คุณไม่มีสิทธิ์เข้าแอดมิน");
        auth.signOut();
      }

    });

  })
  .catch((err)=>{
    alert(err.message);
  });
}

// ===== LOGOUT =====
function logout(){
  auth.signOut().then(()=>{
    document.getElementById("loginBox").style.display="block";
    document.getElementById("adminPanel").style.display="none";
  });
}

// ===== เพิ่มสินค้า =====
function addProduct(){

let name  = document.getElementById("pname").value;
let scent = document.getElementById("pscent").value;
let price = document.getElementById("pprice").value;
let stock = document.getElementById("pstock").value;
let file  = document.getElementById("pimg").files[0];
let sold  = document.getElementById("psold").value || 0;

if(!name || !price || !file){
  alert("กรอกข้อมูลไม่ครบ");
  return;
}

let reader = new FileReader();

reader.onload = function(e){

  let base64Image = e.target.result;

  db.ref("products").push({
  name:name,
  scent:scent,
  price:price,
  stock:stock,
  sold:sold,
  img:base64Image
});

  alert("เพิ่มสินค้าเรียบร้อย");
loadProductAdmin();

  document.getElementById("pname").value="";
  document.getElementById("pscent").value="";
  document.getElementById("pprice").value="";
  document.getElementById("pstock").value="";
  document.getElementById("psold").value="";
  document.getElementById("pimg").value="";

}

reader.readAsDataURL(file);

}

// ===== สลับแท็บ =====
function openTab(id, el){
  let sec = document.querySelectorAll("section");
  let btn = document.querySelectorAll("nav button");

  sec.forEach(s => s.classList.remove("active"));
  btn.forEach(b => b.classList.remove("active"));

  document.getElementById(id).classList.add("active");
  el.classList.add("active");
}

// ===== โหลดออเดอร์ =====
db.ref("orders").on("value", function(snapshot){

document.getElementById("orderList").innerHTML="";

snapshot.forEach(function(child){

  let o = child.val();
  let itemsHTML="";

  if(o.items){
    o.items.forEach(function(i){
      itemsHTML += `<li>${i.name} x ${i.qty} = ${i.price*i.qty} บาท</li>`;
    });
  }

  document.getElementById("orderList").innerHTML += `
  <div class="card">
    <p><b>ลูกค้า:</b> ${o.customer}</p>
    <p><b>โทร:</b> ${o.phone}</p>
    <p><b>ที่อยู่:</b> ${o.address}</p>

    <ul>${itemsHTML}</ul>

    <p><b>ยอด:</b> ${o.total || 0} บาท</p>

    <p><b>สถานะ:</b>
      <select onchange="updateStatus('${child.key}', this.value)">
        <option value="รอชำระเงิน" ${o.status=="รอชำระเงิน"?"selected":""}>รอชำระเงิน</option>
        <option value="รอตรวจสอบ" ${o.status=="รอตรวจสอบ"?"selected":""}>รอตรวจสอบ</option>
        <option value="ชำระเงินแล้ว" ${o.status=="ชำระเงินแล้ว"?"selected":""}>ชำระเงินแล้ว</option>
        <option value="จัดส่งแล้ว" ${o.status=="จัดส่งแล้ว"?"selected":""}>จัดส่งแล้ว</option>
        <option value="ยกเลิกแล้ว" ${o.status=="ยกเลิกแล้ว"?"selected":""}>ยกเลิกแล้ว</option>
      </select>
    </p>

    <p><b>สลิป:</b></p>
    ${
      o.slip
      ? `<img src="${o.slip}" style="width:200px;border-radius:8px">`
      : `<p style="color:red">ยังไม่ได้แนบสลิป</p>`
    }

    <button onclick="deleteOrder('${child.key}')">ลบออเดอร์</button>
  </div>
`;

});

});

// ===== เปลี่ยนสถานะ =====
function updateStatus(id, status){
  db.ref("orders/"+id+"/status").set(status);
}
function deleteOrder(id){
  if(confirm("ต้องการลบออเดอร์นี้หรือไม่?")){
    db.ref("orders/"+id).remove();
  }
}
// ===== โหลดสินค้าสำหรับแอดมิน =====
function loadProductAdmin(){

db.ref("products").once("value", snapshot=>{
  document.getElementById("productList").innerHTML="";

  snapshot.forEach(child=>{
    let p = child.val();

    document.getElementById("productList").innerHTML += `
      <div class="card">
        <p><b>ชื่อ:</b> ${p.name}</p>
        <p><b>กลิ่น:</b> ${p.scent}</p>
        <p><b>ราคา:</b> ${p.price}</p>
        <p><b>คงเหลือ:</b> ${p.stock}</p>

        <button onclick="editProduct('${child.key}',
          '${p.name}','${p.scent}','${p.price}','${p.stock}')">แก้ไข</button>

        <button onclick="deleteProduct('${child.key}')">ลบ</button>
      </div>
    `;
  });
});

}
loadProductAdmin();
// ===== ลบสินค้า =====
function deleteProduct(id){
  if(confirm("ต้องการลบสินค้านี้หรือไม่?")){
    db.ref("products/"+id).remove();
    loadProductAdmin();
  }
}

// ===== แก้ไขสินค้า =====
function editProduct(id,name,scent,price,stock){

  let newName = prompt("ชื่อสินค้า",name);
  let newScent = prompt("กลิ่น",scent);
  let newPrice = prompt("ราคา",price);
  let newStock = prompt("คงเหลือ",stock);

  if(newName && newPrice){
    db.ref("products/"+id).update({
      name:newName,
      scent:newScent,
      price:newPrice,
      stock:newStock
    });

    loadProductAdmin();
  }

}
function uploadLogo(){

let file = document.getElementById("logoFile").files[0];

if(!file){
  alert("กรุณาเลือกรูปโลโก้");
  return;
}

if(file.size > 2 * 1024 * 1024){
  alert("ไฟล์ต้องไม่เกิน 2MB");
  return;
}

let reader = new FileReader();

reader.onload = function(e){

  let base64Logo = e.target.result;

  db.ref("shop/logo").set(base64Logo);

  alert("เปลี่ยนโลโก้เรียบร้อย");
  document.getElementById("logoFile").value="";

}

reader.readAsDataURL(file);

}
</script>

</body>
</html>